<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cursorç”¨æˆ·æ•°æ®ç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #4f46e5;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }
        .header h1 { font-size: 2rem; margin-bottom: 0.5rem; }
        .controls {
            padding: 1.5rem;
            background: #f8fafc;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
            border-bottom: 1px solid #e2e8f0;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); }
        .btn-success { background: var(--success); color: white; }
        .btn-small { padding: 0.5rem 1rem; font-size: 0.85rem; }
        input[type="text"] {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.95rem;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: var(--primary);
        }
        .stats {
            display: flex;
            gap: 2rem;
            margin-left: auto;
        }
        .stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        th {
            background: #f8fafc;
            font-weight: 600;
        }
        tbody tr:hover { background: #f8fafc; }
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .badge-pro { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-warning { background: #fed7aa; color: #92400e; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .days-badge {
            background: linear-gradient(135deg, #34d399, #10b981);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .token-short {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            background: #f8fafc;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: help;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
        }
        .close {
            font-size: 2rem;
            cursor: pointer;
            color: #64748b;
        }
        .close:hover { color: var(--danger); }
        .modal-body { padding: 2rem; }
        textarea {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            min-height: 300px;
            resize: vertical;
        }
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #64748b;
        }
        .empty-icon { font-size: 4rem; opacity: 0.5; }
        .toast {
            position: fixed;
            top: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            animation: slideIn 0.3s;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        .toast-success { background: var(--success); }
        .toast-error { background: var(--danger); }
        .toast-warning { background: var(--warning); }
        [v-cloak] { display: none; }
    </style>
</head>
<body>
    <div id="app" v-cloak>
        <div class="container">
            <div class="header">
                <h1>ğŸ” Cursorç”¨æˆ·æ•°æ®ç®¡ç†ç³»ç»Ÿ</h1>
                <p>è´¦æˆ·ä¿¡æ¯ä¸APIæŸ¥è¯¢</p>
            </div>

            <div class="controls">
                <label class="btn btn-primary">
                    ğŸ“ å¯¼å…¥JSON
                    <input type="file" @change="handleFile" accept=".json" style="display:none">
                </label>
                <button class="btn btn-primary" @click="showTextModal = true">ğŸ“ ç²˜è´´JSON</button>
                <button v-if="hasTokens" class="btn btn-success" @click="batchQuery" :disabled="querying">
                    {{ querying ? `â³ ${progress}` : 'ğŸ”„ æ‰¹é‡æŸ¥è¯¢' }}
                </button>
                <input type="text" v-model="search" placeholder="ğŸ” æœç´¢é‚®ç®±...">
                <div class="stats">
                    <div>
                        <span style="color: #64748b">æ€»è´¦æˆ·ï¼š</span>
                        <span class="stat-value">{{ filtered.length }}</span>
                    </div>
                    <div>
                        <span style="color: #64748b">æœ‰æ•ˆTokenï¼š</span>
                        <span class="stat-value">{{ validTokens }}</span>
                    </div>
                </div>
            </div>

            <div v-if="filtered.length">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Email</th>
                            <th>Token</th>
                            <th>ä¼šå‘˜</th>
                            <th>å‰©ä½™</th>
                            <th>çŠ¶æ€</th>
                            <th>æ³¨å†Œæ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(item, i) in filtered" :key="i" :style="rowStyle(item)">
                            <td>{{ i + 1 }}</td>
                            <td><strong>{{ item.email }}</strong></td>
                            <td>
                                <span v-if="item.auth_info?.WorkosCursorSessionToken" 
                                      class="token-short" 
                                      :title="item.auth_info.WorkosCursorSessionToken">
                                    {{ shortToken(item.auth_info.WorkosCursorSessionToken) }}
                                </span>
                                <span v-else style="color: #94a3b8">æ— Token</span>
                            </td>
                            <td v-html="memberBadge(item)"></td>
                            <td v-html="daysBadge(item)"></td>
                            <td v-html="statusBadge(item)"></td>
                            <td>{{ item.register_time || 'N/A' }}</td>
                            <td>
                                <button v-if="item.auth_info?.WorkosCursorSessionToken" 
                                        class="btn btn-success btn-small" 
                                        @click="queryOne(i)"
                                        :disabled="item.loading">
                                    {{ item.loading ? 'â³' : 'ğŸ”' }}
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div v-else class="empty-state">
                <div class="empty-icon">ğŸ“‹</div>
                <h3>æš‚æ— æ•°æ®</h3>
                <p>è¯·å¯¼å…¥JSONæ–‡ä»¶æˆ–ç²˜è´´JSONæ•°æ®</p>
            </div>
        </div>

        <!-- æ–‡æœ¬å¯¼å…¥ -->
        <div v-if="showTextModal" class="modal" @click.self="showTextModal = false">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>ğŸ“ ç²˜è´´JSONæ–‡æœ¬</h2>
                    <span class="close" @click="showTextModal = false">&times;</span>
                </div>
                <div class="modal-body">
                    <textarea v-model="jsonText" placeholder="ç²˜è´´JSONæ•°æ®..."></textarea>
                    <button class="btn btn-primary" @click="importText" style="margin-top: 1rem">
                        âœ… å¯¼å…¥
                    </button>
                </div>
            </div>
        </div>

        <!-- æ¶ˆæ¯æç¤º -->
        <div v-if="toast.show" :class="['toast', `toast-${toast.type}`]">
            {{ toast.text }}
        </div>
    </div>

    <script>
    const { createApp } = Vue;
    
    createApp({
        data: () => ({
            data: [],
            search: '',
            showTextModal: false,
            jsonText: '',
            querying: false,
            progress: '',
            toast: { show: false, text: '', type: 'success' },
            apiBase: '/api/auth/stripe'  // Vercel APIè·¯ç”±
        }),
        computed: {
            filtered() {
                if (!this.search) return this.data;
                const q = this.search.toLowerCase();
                return this.data.filter(d => d.email?.toLowerCase().includes(q));
            },
            hasTokens() {
                return this.data.some(d => d.auth_info?.WorkosCursorSessionToken);
            },
            validTokens() {
                return this.filtered.filter(d => 
                    d.auth_info?.WorkosCursorSessionToken && d.tokenValidity !== false
                ).length;
            }
        },
        methods: {
            handleFile(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        this.loadData(JSON.parse(e.target.result));
                    } catch (err) {
                        this.showToast('JSONè§£æå¤±è´¥', 'error');
                    }
                };
                reader.readAsText(file);
            },
            importText() {
                try {
                    this.loadData(JSON.parse(this.jsonText));
                    this.showTextModal = false;
                    this.jsonText = '';
                } catch (err) {
                    this.showToast('JSONæ ¼å¼é”™è¯¯', 'error');
                }
            },
            loadData(d) {
                if (!Array.isArray(d)) throw new Error('æ•°æ®å¿…é¡»æ˜¯æ•°ç»„');
                this.data = d.map(item => ({ ...item, loading: false }));
                this.showToast(`å¯¼å…¥æˆåŠŸï¼${d.length}æ¡è®°å½•`, 'success');
            },
            async queryOne(i) {
                const item = this.filtered[i];
                let token = item.auth_info?.WorkosCursorSessionToken;
                if (!token) return;

                // Tokenä¿æŒåŸæ ·å‘é€ï¼ŒAPIå‡½æ•°ä¼šå¤„ç†ç¼–ç 
                // å¦‚æœæ˜¯URLç¼–ç çš„ï¼ˆ%3A%3Aï¼‰ä¿æŒåŸæ ·
                // å¦‚æœæ˜¯è§£ç çš„ï¼ˆ::ï¼‰ä¹Ÿä¿æŒåŸæ ·ï¼ŒAPIä¼šç¼–ç 
                
                item.loading = true;
                try {
                    console.log(`[å‰ç«¯] å‘é€Token: ${token.substring(0, 50)}...`);
                    
                    const res = await axios.get(this.apiBase, {
                        headers: {
                            'X-Cursor-Token': token
                        }
                    });
                    
                    item.apiData = res.data;
                    this.showToast('âœ… æŸ¥è¯¢æˆåŠŸ', 'success');
                } catch (err) {
                    console.error('æŸ¥è¯¢å¤±è´¥:', err);
                    const msg = err.response?.status === 401 
                        ? 'âŒ Tokenæ— æ•ˆæˆ–å·²è¿‡æœŸ' 
                        : 'âŒ æŸ¥è¯¢å¤±è´¥ï¼š' + (err.response?.data?.message || err.message || 'æœªçŸ¥é”™è¯¯');
                    this.showToast(msg, 'error');
                } finally {
                    item.loading = false;
                }
            },
            async batchQuery() {
                const items = this.filtered.filter(d => d.auth_info?.WorkosCursorSessionToken);
                if (!items.length) return;

                this.querying = true;
                let success = 0, fail = 0;

                for (let i = 0; i < items.length; i++) {
                    this.progress = `${i + 1}/${items.length}`;
                    const item = items[i];
                    const token = item.auth_info.WorkosCursorSessionToken;
                    
                    try {
                        const res = await axios.get(this.apiBase, {
                            headers: { 'X-Cursor-Token': token }
                        });
                        item.apiData = res.data;
                        success++;
                    } catch (err) {
                        console.error(`è´¦å· ${item.email} æŸ¥è¯¢å¤±è´¥:`, err);
                        fail++;
                    }
                    
                    await new Promise(r => setTimeout(r, 500));
                }

                this.querying = false;
                this.showToast(`å®Œæˆï¼æˆåŠŸ:${success} å¤±è´¥:${fail}`, fail ? 'warning' : 'success');
            },
            shortToken(t) {
                if (!t || t.length <= 20) return t;
                return `${t.substring(0, 10)}...${t.substring(t.length - 6)}`;
            },
            memberBadge(item) {
                const type = item.apiData?.membershipType || item.membershipType || 'unknown';
                const map = {
                    pro: '<span class="badge badge-pro">PRO</span>',
                    free: '<span class="badge">Free</span>',
                    free_trial: '<span class="badge badge-warning">è¯•ç”¨</span>',
                };
                return map[type] || '<span class="badge">æœªçŸ¥</span>';
            },
            daysBadge(item) {
                const days = item.apiData?.daysRemainingOnTrial ?? item.daysRemainingOnTrial;
                const type = item.apiData?.membershipType || item.membershipType;
                
                if (days != null) return `<span class="days-badge">${days}å¤©</span>`;
                if (type === 'pro') return '<span style="color:#10b981;font-weight:600">âˆ</span>';
                return '-';
            },
            statusBadge(item) {
                const token = item.auth_info?.WorkosCursorSessionToken;
                if (!token) return '<span class="badge badge-danger">æ— Token</span>';
                if (item.tokenValidity === false) return '<span class="badge badge-warning">å¤±æ•ˆ</span>';
                return '<span class="badge badge-success">æœ‰æ•ˆ</span>';
            },
            rowStyle(item) {
                const token = item.auth_info?.WorkosCursorSessionToken;
                if (!token) return { opacity: 0.6, background: '#fef2f2' };
                if (item.tokenValidity === false) return { background: '#fff7ed' };
                if (item.apiData) return { background: '#f0fdf4' };
                return {};
            },
            showToast(text, type = 'success') {
                this.toast = { show: true, text, type };
                setTimeout(() => this.toast.show = false, 3000);
            }
        }
    }).mount('#app');
    </script>
</body>
</html>
