# 🏗️ 项目架构说明

## 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                           用户浏览器                              │
│  ┌───────────────────────────────────────────────────────┐      │
│  │              index.html (主页面)                       │      │
│  │  - 输入框（Token）                                     │      │
│  │  - 查询按钮                                           │      │
│  │  - 结果展示区                                         │      │
│  └───────────────────────────────────────────────────────┘      │
│                            ↓                                     │
│  ┌───────────────────────────────────────────────────────┐      │
│  │         public/script.js (前端逻辑)                    │      │
│  │  - 事件处理                                           │      │
│  │  - API 调用                                           │      │
│  │  - 数据展示                                           │      │
│  │  - LocalStorage 管理                                  │      │
│  └───────────────────────────────────────────────────────┘      │
│                            ↓                                     │
│  ┌───────────────────────────────────────────────────────┐      │
│  │       public/style.css (样式)                          │      │
│  │  - 深色主题                                           │      │
│  │  - 响应式布局                                         │      │
│  │  - 动画效果                                           │      │
│  └───────────────────────────────────────────────────────┘      │
└─────────────────────────────────────────────────────────────────┘
                            ↓ HTTPS
┌─────────────────────────────────────────────────────────────────┐
│                      Vercel 平台                                 │
│  ┌───────────────────────────────────────────────────────┐      │
│  │              Serverless Functions                     │      │
│  │  ┌───────────────────┐  ┌───────────────────┐       │      │
│  │  │  api/stripe.js    │  │  api/usage.js     │       │      │
│  │  │  - 代理请求       │  │  - 代理请求       │       │      │
│  │  │  - 添加 Headers   │  │  - 添加 Headers   │       │      │
│  │  │  - 错误处理       │  │  - 错误处理       │       │      │
│  │  └───────────────────┘  └───────────────────┘       │      │
│  └───────────────────────────────────────────────────────┘      │
└─────────────────────────────────────────────────────────────────┘
                            ↓ HTTPS
┌─────────────────────────────────────────────────────────────────┐
│                      Cursor.com API                              │
│  ┌───────────────────────────────────────────────────────┐      │
│  │  GET /api/auth/stripe                                 │      │
│  │  - 返回订阅信息                                       │      │
│  └───────────────────────────────────────────────────────┘      │
│  ┌───────────────────────────────────────────────────────┐      │
│  │  POST /api/dashboard/get-aggregated-usage-events      │      │
│  │  - 返回使用统计                                       │      │
│  └───────────────────────────────────────────────────────┘      │
└─────────────────────────────────────────────────────────────────┘
```

---

## 目录结构

```
cursor-usage-checker/
│
├── api/                          # Serverless API 函数
│   ├── stripe.js                 # 订阅信息查询 API
│   └── usage.js                  # 使用统计查询 API
│
├── public/                       # 静态资源
│   ├── style.css                 # 样式文件
│   └── script.js                 # 前端脚本
│
├── index.html                    # 主页面
├── vercel.json                   # Vercel 配置
├── package.json                  # 项目配置
│
├── .gitignore                    # Git 忽略文件
├── .vercelignore                 # Vercel 忽略文件
│
├── README.md                     # 项目说明
├── DEPLOY.md                     # 部署指南
├── CHANGELOG.md                  # 更新日志
├── LICENSE                       # 开源协议
├── 快速开始.md                   # 快速开始
├── 使用示例.md                   # 使用示例
└── 项目架构.md                   # 本文件
```

---

## 数据流程

### 1. 用户查询流程

```
用户输入 Token
    ↓
前端验证输入
    ↓
调用 /api/stripe 和 /api/usage
    ↓
Serverless 函数添加必要的 Headers
    ↓
转发请求到 Cursor.com API
    ↓
接收 Cursor API 响应
    ↓
返回数据给前端
    ↓
前端解析并展示数据
    ↓
保存 Token 到 LocalStorage
```

### 2. API 代理流程

```
接收前端请求
    ↓
提取 Token
    ↓
构造请求 Headers
    ↓
设置 Cookie: WorkosCursorSessionToken
    ↓
发送请求到 Cursor.com
    ↓
接收响应
    ↓
处理错误（如果有）
    ↓
返回 JSON 数据
```

---

## 核心组件说明

### 前端 (index.html + script.js + style.css)

**职责**：
- 用户界面展示
- 用户交互处理
- 数据展示和格式化
- Token 本地存储

**技术特点**：
- 原生 JavaScript（无框架依赖）
- 现代 CSS（Grid + Flexbox）
- LocalStorage API
- Fetch API

### 后端 (api/*.js)

**职责**：
- 接收前端请求
- 代理转发到 Cursor API
- 添加必要的请求头
- 错误处理和日志

**技术特点**：
- Vercel Serverless Functions
- Node.js 环境
- Fetch API
- CORS 处理

### 配置文件

**vercel.json**：
- 定义路由规则
- 配置构建设置
- 设置 CORS 头

**package.json**：
- 项目元信息
- 依赖管理
- 脚本命令

---

## 安全设计

### 1. Token 安全

- ✅ Token 不在代码中硬编码
- ✅ Token 只存储在用户浏览器
- ✅ 服务器端不记录 Token
- ✅ 使用 HTTPS 加密传输

### 2. CORS 配置

```javascript
res.setHeader('Access-Control-Allow-Origin', '*');
res.setHeader('Access-Control-Allow-Methods', 'GET,POST');
res.setHeader('Access-Control-Allow-Headers', 'Content-Type');
```

### 3. 请求验证

- 验证 Token 是否存在
- 验证请求方法（只允许 POST）
- 错误响应不泄露敏感信息

---

## 性能优化

### 1. 并行请求

```javascript
const [stripeData, usageData] = await Promise.all([
    fetchStripeInfo(token),
    fetchUsageStats(token)
]);
```

### 2. CDN 加速

- Vercel 自动提供全球 CDN
- 静态资源自动缓存
- 智能路由选择最近节点

### 3. 代码优化

- 最小化 DOM 操作
- 事件委托
- 懒加载（原始数据折叠）

---

## 扩展性设计

### 添加新 API

1. 在 `api/` 目录创建新的 `.js` 文件
2. 导出 default handler 函数
3. 在 `vercel.json` 中添加路由（自动）
4. 在前端添加调用逻辑

示例：
```javascript
// api/new-feature.js
export default async function handler(req, res) {
    // 你的逻辑
}
```

### 添加新功能

1. 在 `public/script.js` 中添加函数
2. 在 `index.html` 中添加 UI 元素
3. 在 `public/style.css` 中添加样式

---

## 部署流程

```
开发 → Git 提交 → 推送到 GitHub → Vercel 自动构建 → 部署到生产
```

### 自动化部署

- 每次推送到 main 分支自动触发部署
- Vercel 自动检测变更
- 构建完成后自动发布
- 支持预览部署（PR）

---

## 监控与日志

### 查看日志

1. 登录 Vercel Dashboard
2. 选择项目
3. 进入 "Functions" → "Logs"
4. 查看实时日志

### 性能监控

- Vercel Analytics（可选）
- 响应时间监控
- 错误率统计

---

## 故障排查

### 常见问题

1. **API 404**
   - 检查 `vercel.json` 路由配置
   - 确认 API 文件路径正确

2. **CORS 错误**
   - 检查 API 函数中的 CORS 头设置
   - 确认 OPTIONS 请求处理正确

3. **Token 无效**
   - Token 可能已过期
   - 检查 Token 格式是否完整

### 调试技巧

- 使用浏览器开发者工具 Network 标签
- 查看 Vercel 函数日志
- 在代码中添加 console.log
- 使用 `vercel dev` 本地调试

---

## 技术选型说明

### 为什么选择 Vercel？

✅ 免费额度充足  
✅ 部署简单快速  
✅ 自动 HTTPS  
✅ 全球 CDN  
✅ 良好的开发体验  

### 为什么使用原生 JS？

✅ 无构建步骤  
✅ 加载速度快  
✅ 易于维护  
✅ 兼容性好  

### 为什么使用 Serverless？

✅ 按需计费  
✅ 自动扩展  
✅ 无需服务器管理  
✅ 冷启动快  

---

## 最佳实践

1. **代码组织**
   - 保持函数简洁
   - 单一职责原则
   - 适当的注释

2. **错误处理**
   - 捕获所有可能的异常
   - 返回友好的错误信息
   - 记录详细的日志

3. **安全性**
   - 不在前端暴露敏感信息
   - 验证所有输入
   - 使用 HTTPS

4. **性能**
   - 减少不必要的请求
   - 使用并行请求
   - 合理使用缓存

---

需要更深入了解？查看 [README.md](./README.md) 或 [使用示例.md](./使用示例.md)

